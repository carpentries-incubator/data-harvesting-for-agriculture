---
title: "Ag Carpentry - Geospatial Data in different Ag file formats"
author: "Brittani"
date: "10/19/2019"
output: html_document
---

```{r setup, include=FALSE}
library("sf")
library("fasterize")
library("gstat")
library("raster")
library("rjson")
library("httr")
library("rgdal")
library(rgeos)
library(maptools)
library(knitr)
require("tmap")
require("ggplot2")
require("gridExtra")
knitr::opts_chunk$set(echo = TRUE)
opts_knit$set(root.dir = "~/Box/EC for VR Mgt Paper San Antonio/Data/hord f98")
```
####Motivating Questions:
- What are the common file types in agricultural data?
- What applications do I need to open these files?
- How can I make maps of my yield or application?
- What publicly available datasets exist for my field?

####Objectives with Spatial Data:
- Determine whether data are stored in vector or raster format
- Identify the coordinate system for a dataset
- Talk about when data don't have a projection defined (missing .prj file)
- Determine UTM zone of a dataset
- Reproject the dataset into UTM
- Import geospatial files into your R environment
- Visualize geospatial data with R
- Create geospatial files from lat/long coordinates
- Create an ab-line

####Objectives with Agricultural Data Types
- Describe the contents of files generated during planting, fertilization, and harvest
- Describe the contents of files used to control seeding and fertilization rate
- Describe the format of public weather and soil datasets
- Import agricultural datasets into R
- Import weather data from the internet, eg. daymetr
- Access elevation and ssurgo data with higher resolution
- Derive topography data from elevation data

####Keypoints:
- sf is prefereable for data analysis; it is easier to access the dataframe
- Projecting your data in utm is necessary for many of the geometric operations you perform (e.g. making trial grids and splitting plots into subplot data)
- Different data formats that you are likely to encounter include gpkg, shp (cpg, dbf, prj, sbn, sbx), geojson, and tif

###Introducing Spatial Data with an Example Using Trial Design Data

####Read in the trial design

Use the function `read_sf()` to bring the dataset into your R environment. Because we have already set the working directory for this file, we only need to supply the file name. There are many functions for reading files into the environment, but this function will create an object of class `sf`. This class makes accessing the data in spatial data much easier. With an `sf` object, you can reach a variable inside a dataframe with `trial$var`. With another common class called `spdf` you need to use  `trial@data$var`. First you must go into the data part of the object `trial` and then you can access `var`. For this and other reasons like the number of spatial calculations available for `sf` objects, this class is perferred in most situations. 
```{r readtrial}
trial <- read_sf("hord_f98_trialdesign_2017.shp")
```

An `sf` object contains a geometry column. We can see the geometric points for each polygon. The geometry contains the points for each polygon.
```{r geometry}
head(trial$geometry)
```

####Check the coordinate reference system

Geospatial data has a coordinate reference system that projects the map in a specific location. Different CRSs use different projections of the earth into 2-dimensional space. Some coordinate reference systems, such as UTM zones, are measured in meters from a reference point in the zone. Before combining files and performing operations on a file, it is important to check the CRS. The function for this is `crs().`
```{r checkCRS}
crs(trial)
```
The trial design is in lat/long. If we want to create measures of distance, we need the trial design in UTM. First, we must determine the UTM zone of the trial area. 

####Calculate the UTM zone from the longitude

The UTM system divides the surface of Earth between 80°S and 84°N latitude into 60 zones, each 6° of longitude in width. Zone 1 covers longitude 180° to 174° W; zone numbering increases eastward to zone 60 that covers longitude 174 to 180 East. The following code takes a longitude point and determines its UTM zone. `long2UTM()` is a function written to take the argument `long` and output the result of the equation. `floor()` returns the largest integer that is not greater than the input. 
```{r calcutm}
long2UTM = function(long) {(floor((long + 180)/6) %% 60) + 1}
utmzone = long2UTM(mean(st_bbox(trial)[c(1,3)]))
```

####Projection for utm

Using the UTM zone we calculated in above, we now need the full ESPG code to transform the file to the new CRS. EPSG Geodetic Parameter Dataset is a public registry of spatial reference systems, Earth ellipsoids, coordinate transformations and related units of measurement. The ESPG is one way to assign or transform the CRS in R. The ESPG for UTM always begins with "326" and the last numbers are the number of the zone. The code below pastes together the full ESPG code for any `utmzone` we calculate with `long2UTM`. `paste0()` pastes together the two arguments `"+init=epsg:326"` and `utmzone`.
```{r setcrs}
projutm <<- st_crs(paste0("+init=epsg:326", utmzone)) 
```

**Challenge**: What does `st_crs()` do? Why do we take this step? Hint: Use help to look up the function and check the class of `projutm`.

####Transform the projection of file

To transform the trial design file into UTM, use `st_transform` and the crs object `projutm`.
```{r transform}
trialutm<-st_transform(trial,projutm)
```

####Save the file 

You can save the file as a .gpkg or .shp file. The advantage of a .gpkg file is that you only save one file rather than four files in a shapefile. Because shapefiles contain multiple files, they can be corrupted if one piece is missing. One example is a .prj file. In this case, the shapefile will have no CRS, and you will need to determine the CRS of the object. 

**Challenge**: How would you go about determining the CRS of an object with no .prj? Hint: Use what you can view in R.


The new .gpkg file will be visible in your working directory. One common problem with these files is that when you try to open a .gpkg file for the first time in R, it might not work if you haven't opened it in QGIS before. 
```{r save}
st_write(trialutm,"trial.gpkg", layer_options = 'OVERWRITE=YES', update = TRUE)
```

####Visualize the trialmap

First, we need to know what variables are in the trial dataset.
Use `names()` to view the different variables in `trial`. Say we want to make a map of the nitrogen rates. We need to identify the variable name for the target nitrogen. 
```{r trialsumm}
names(trialutm)
```

The following map is created with functions from a package called `tmap`. We are filling the polygons with a color based on the variable `NRATE` inside the object  `trialutm `. There are other arguments here choosing the position of the map legend, title of the variable, size of text, and width of legend.
```{r map}
tm_shape(trialutm) + tm_polygons('NRATE',title = "Nitrogen Rate") + tm_layout(legend.outside = TRUE,frame=FALSE)+
  tm_legend(text.size=1,
            title.size=1,
            width=100,
            bg.color = "white"
           )
```

**Challenge**: Use the code to answer the following questions: Why do we supply a title in `tm+polygons ` and why is `legend.outside=TRUE`?

#####Your turn:
Map a map of the seeding rate.

####Creating Spatial Objects

You may also have the coordinates of a spatial object but not a spatial file. One example is a boundary file or AB-line for your field. We will use the AB-line and boundary files later when designing the trials. But for this example, they are good for displaying how to create a spatial object from coordinates. 

####AB-line File (reading it in or creating it)

Define the latitude and longitude of the two points.
```{r points }
LongA <- -82.97452
LatA <- 40.73862

LongB <- -82.97452
LatB <- 40.74480
```

Combine the two points into a dataframe with `rbind()` and create a `sf` object using `st_sf()`. `st_sfc()` creates a simple feature geometry column from a set of geometries like our coordinates in `ab_string`. 
```{r abline }
ab_string <- rbind(c(LongA,LatA),c(LongB,LatB)) %>% st_linestring() 
ab_line <-st_sf(id='ab_line',st_sfc(ab_string))
```

Now we must assign the CRS of the line. We know that the coordinates were taken from an object in WGS84, so we can assign the same CRS with `st_crs` and typing out the correct `crs`. Another way we can do this is by using `crs()`. This second method is preferred to avoid mistakes when remembering the UTM zone of multiple files.
```{r ab_lineproj}
st_crs(ab_line) <- crs(trial)
st_crs(ab_line)
st_write(ab_line,"abline.gpkg", layer_options = 'OVERWRITE=YES', update = TRUE)
```

Plot the resulting AB-line with the generic plotting function for `sf` objects. 
```{r plotabline }
plot(ab_line)
```

####Obtaining the Boundary File (reading it in or creating it)
```{r boundary}
library(sp)
x_coord <- c(-82.97853,-82.97306,-82.97306, -82.97853, -82.97853)
y_coord <- c(40.73945, 40.73945, 40.74660, 40.74660, 40.73945)
xym <- cbind(x_coord, y_coord)
```

```{r viewcoord}
xym
```

```{r createpoly}
p = Polygon(xym)
ps = Polygons(list(p),1)
sps = SpatialPolygons(list(ps))
```

```{r plotboundary}
plot(sps)
```

```{r savepoly}
st_write(ab_line,"abline.gpkg", layer_options = 'OVERWRITE=YES', update = TRUE)
```

####File Types
1. Trial Yield Data
2. As-applied Data
3. As-planted Data
4. EC Data
5. Elevation Data (from Internet or Trial Yield/As-planted file)
6. Topography Data (Slope and Aspect generated from Elevation Data)
7. SSURGO Data (Specify the soil content)
8. Weather Data (daily/weekly/monthly data)



