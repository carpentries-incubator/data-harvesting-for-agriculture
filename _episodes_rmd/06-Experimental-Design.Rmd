---
title: "Experimental Design"
include_overview: true
output: html_document
questions:
 - What kind of on-farm experiments do we do?
 - How do we design these experiments efficiently?
objectives:
 - Know different types of common on-farm experiments
 - Import boundary file and AB line file
 - Create AB line file with code
 - utilize the functions to create simple trial designs
keypoints:
 - Most of the code in this part would be using the functions, therefore understanding what different functions can be quite important
 - In designing the trials, the most important thing is to know how to design the experimental rates,and the tech part can be done by someone else
source: Rmd
---


```{r setup, include=FALSE}
library(knitr)
library(sf)
library(fasterize)
library(raster)
library(rjson)
library(httr)
library(rgdal)
library(rgeos)
library(maptools)
library(knitr)
require(tmap)
require(ggplot2)
require(gridExtra)
library(daymetr)
library(readr)
library(measurements)
library(FedData)
library(lubridate)
library(data.table)
library(dplyr)
library(tidyverse)
library(tidyr)
library(broom)
source("../bin/chunk-options.R")
source("functions.R")
```

Now we will design our own experiments to do on our plots.  
The only files we need for the trial design are the boundary file, and ab line.

<!-- JPN: add in if we have time: In addition, as long as we know the actual direction the machines
will be driven on the field, we can create our own AB line with a function. -->

## Read and transform shape files

We will start by reading in the shape files we need like we've been doing for the last few episodes:
```{r}
boundary <- st_read("data/boundary.gpkg") # read in boundary
abline <- st_read("data/abline.gpkg") # read in AB line
```

<!-- JPN: here is where we can have a popout "what if no abline file" -->
<!-- JPN: add if time
### make our own AB line if you do not already have one
ABline stuff creation here if we can figure it out
-->


Now let's check the coordinate references of our two files:
```{r}
st_crs(boundary)
```
```{r}
st_crs(abline)
```

Since both of these are in lat/long and we want them in UTM, we'll transform them:

```{r}
boundary_utm <- st_transform_utm(boundary)
```

```{r}
abline_utm <- st_transform_utm(abline)
```


## Designing trials

We need decide on the experiment design before we get into any of the code.  Relative parameters we need for the trial design includes:
 * plot dimension
 * number of treatments
 * types of treatments, and
 * treatment range.

In the following code, we are simply going to assign values to all
the parameters that might be involved in the trial design. In this way, if we ever want to change any parameters, we can do it here, and need not
to worry about the consistency for the whole code.

First, we want to make sure we don't plan any trials on the "Headlands", so let's make sure we only take the "Trial" portion of our shapefile:

```{r}
trialarea <- subset(boundary_utm, Type == "Trial")
```

Now let's design our grid with the following parameters:
```{r}
width_in_meters = 24 # width of grids is 24 meters
long_direction = 'NS' # WAIT
short_directon = 'EW' # WAIT
length_in_ft = 180 # in feet
```

We'll use our `make_grids` function to 


```{r design the checker-board plot}
width <- m_to_ft(24)
design_grids_utm <- make_grids(trialarea, abline_utm, long_in = 'NS', short_in = 'EW', length_ft = 180, width_ft = width)

st_crs(design_grids_utm) <- st_crs(trialarea)
trial_grid <- st_intersection(trialarea, design_grids_utm)

tm_shape(trial_grid) + tm_borders(col='blue')

```

### determine treatment types
Now that we have the trial design plots, we need to assign different treatments to each plot.
```{r assigning treatment rates, message=FALSE, warning=FALSE}
whole_plot <- treat_assign(trialarea, trial_grid, head_buffer_ft = width, seed_treat_rates = c(31000, 34000, 37000, 40000), nitrogen_treat_rates = c(160,200,225,250), seed_quo = 37000, nitrogen_quo = 225)
map_poly(whole_plot, "NRATE", "Nitrogen Treatment")
```
```{r}
plot(newfield$geom)
```

```{r cleanup}
# infield <- st_buffer(boundary.utm, -plot_width_meter)
# outfield <- st_difference(boundary.utm, infield)
# 
# infield$dummy <- 1
# outfield$dummy <- 0
# bothfields <- rbind(infield, outfield)
# newfield <- subset(bothfields, dummy == 1)
```


###eg plot

```{r}
ggplot(data = whole_plot, aes(x=long,y=lat,group=group)) +
  geom_polygon(aes(fill=factor(NRATE))) +
  scale_fill_brewer(palette = 'Greens') 
```
